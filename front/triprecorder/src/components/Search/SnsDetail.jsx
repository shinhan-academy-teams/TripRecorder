import { ExclamationCircleFilled } from "@ant-design/icons";
import { Button, Carousel, Modal, Space, message } from "antd";
import TextArea from "antd/es/input/TextArea";
import api from "api/axios";
import profileService from "api/profile.service";
import React from "react";
import { useEffect } from "react";
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useRecoilState } from "recoil";
import { profileUserNo } from "recoil/Profile";
import "style/sns.scss";
const { confirm } = Modal;

const SnsDetail = ({ snsData, snsList, updateSnsList }) => {
  const [prfUserNo, setPrfUserNo] = useRecoilState(profileUserNo);
  // ë§í¬ ì´ë™
  const navigate = useNavigate();
  // ê²Œì‹œê¸€ ì‚¬ì§„, ëŒ“ê¸€, í•´ì‹œíƒœê·¸ ì •ë³´ (ë¦¬ìŠ¤íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ì •ë³´)
  const [photoData, setPhotoData] = useState([]);
  const [replyData, setReplyData] = useState([]);
  const [hashtagData, setHashtagData] = useState([]);
  // ì¢‹ì•„ìš” ê´€ë ¨ ì •ë³´
  const [heart, setHeart] = useState();
  const [heartCnt, setHeartCnt] = useState();
  // ëŒ“ê¸€ ì‘ì„± ë‚´ìš©
  const [replyContent, setReplyContent] = useState("");
  // ê²½ë¹„, ê²½ë¹„ ëª¨ë‹¬
  const [exp, setExp] = useState({ expTitle: "", expPlace: "", expMoney: 0 });
  const [isModalOpen, setIsModalOpen] = useState(false);
  // í˜„ì¬ ë¡œê·¸ì¸ì¤‘ì¸ ì‚¬ìš©ì ë²ˆí˜¸
  const userNo = localStorage.getItem("userNo");

  // ì»´í¬ë„ŒíŠ¸ ë¡œë“œ ì‹œ ë°ì´í„° ì„¤ì •
  useEffect(() => {
    setPhotoData(snsData?.snsPhoto?.map((data) => data));
    setReplyData(snsData?.reply?.map((data) => data));
    setHashtagData(snsData?.hashtag?.map((data) => data));
    setHeart(snsData?.heart);
    setHeartCnt(snsData?.heartCnt);
  }, [snsData]);

  // ì¢‹ì•„ìš” ë“±ë¡ ë° ì·¨ìˆ˜
  const heartClick = () => {
    userNo
      ? api
          .post("/heart/register/" + snsData.snsNo)
          .then((res) => {
            const result = res.data;
            setHeart(result);

            result
              ? message.success("ê²Œì‹œê¸€ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.")
              : message.success("ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.");
            result ? setHeartCnt(heartCnt + 1) : setHeartCnt(heartCnt - 1);
          })
          .catch((err) => console.log("error", err))
      : message.error("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!");
  };

  // ëŒ“ê¸€ ì‘ì„±
  const replyRegisterChange = (event) => {
    setReplyContent(event.target.value);
  };
  const replyRegisterClick = () => {
    userNo
      ? api
          .post("/reply/register/" + snsData?.snsNo, { replyContent })
          .then((res) => {
            message.success("ëŒ“ê¸€ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. ğŸ˜Š");

            console.log(res.data);
            setReplyData([...replyData, res.data]);
            setReplyContent("");
          })
          .catch((err) => {
            message.error("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ğŸ˜¥");
            console.log(err);
          })
      : message.error("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!");
  };
  // ëŒ“ê¸€ ì‚­ì œ
  const replyDeleteClick = (event) => {
    const replyNo = event.currentTarget.getAttribute("value");
    confirm({
      title: "ëŒ“ê¸€ ì‚­ì œ",
      icon: <ExclamationCircleFilled />,
      content: "ì •ë§ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
      okText: "Yes",
      okType: "danger",
      cancelText: "No",
      onOk() {
        api
          .delete("/reply/delete/" + replyNo)
          .then(() => {
            message.success("ëŒ“ê¸€ ì‚­ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
            setReplyData(replyData.filter((reply) => reply.replyNo != replyNo));
          })
          .catch(() => message.error("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
      },
      onCancel() {
        console.log("Cancel");
      },
    });
  };
  // ì‚¬ìš©ì í”„ë¡œí•„ë¡œ ì´ë™
  const moveToProfile = (event) => {
    const userNick = event.currentTarget.getAttribute("value");
    console.log(userNo, "####");
    navigate(`${userNick}`);
    profileService.getUserNo(userNick).then((res) => {
      console.log(res, "@@@@@@@2");
      setPrfUserNo(res);
    });
  };
  // ê²½ë¹„ ëª¨ë‹¬
  const showExpInfo = (event) => {
    const expNo = event.currentTarget.getAttribute("value");
    api
      .post("exp/sns/" + expNo)
      .then((res) => {
        console.log(res);
        setExp(res.data);
        setIsModalOpen(true);
      })
      .catch((err) => console.log("error", err));
  };
  const handleOk = () => {
    setIsModalOpen(false);
  };
  const handleCancel = () => {
    setIsModalOpen(false);
  };
  // ê²Œì‹œê¸€ ì‚­ì œ
  const snsDeleteClick = (event) => {
    const snsNo = event.currentTarget.getAttribute("value");
    confirm({
      title: "ê²Œì‹œê¸€ ì‚­ì œ",
      icon: <ExclamationCircleFilled />,
      content: "ì •ë§ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
      okText: "Yes",
      okType: "danger",
      cancelText: "No",
      onOk() {
        console.log(snsNo);
        api
          .delete("/sns/delete/" + snsNo)
          .then(() => {
            message.success("ê²Œì‹œê¸€ ì‚­ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
            const newList = snsList.filter((sns) => sns?.snsNo != snsNo);
            console.log(newList);
            updateSnsList(newList);
          })
          .catch(() => message.error("ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
      },
      onCancel() {
        console.log("Cancel");
      },
    });
  };

  return (
    <div className="all">
      {/* ê²Œì‹œê¸€ ì‚¬ì§„ */}
      <div className="leftDiv">
        <Carousel style={{ width: "600px" }}>
          {photoData?.map((src, i) => {
            return (
              <div key={i}>
                <img
                  src={src}
                  style={{ width: "600px", height: "600px" }}
                  alt="ê²Œì‹œë¬¼"
                />
              </div>
            );
          })}
        </Carousel>
      </div>
      <div className="rightDiv" style={{ textAlign: "left" }}>
        {/* ê²Œì‹œê¸€ ì‘ì„±ì ë° ë‚´ìš©, í•´ì‹œíƒœê·¸ */}
        <div style={{ height: "250px" }}>
          <div className="profile1">
            <img
              onClick={moveToProfile}
              value={snsData?.snsUser.userNick}
              className="profileImg"
              src={snsData?.snsUser.userProfile}
              alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
            />
            <div>
              <h2 value={snsData?.snsUser.userNick} onClick={moveToProfile}>
                {snsData?.snsUser.userNick}
              </h2>
              <h3>{snsData?.snsContent}</h3>
              {hashtagData?.map((hashtag, i) => {
                return <span key={i}>{hashtag} </span>;
              })}
              <p>
                {snsData
                  ? new Date(snsData?.snsRegdate).toISOString().split("T")[0] +
                    " " +
                    new Date(snsData?.snsRegdate)
                      .toISOString()
                      .split("T")[1]
                      .split(".")[0]
                  : ""}
              </p>
            </div>
          </div>
          {/* ì¢‹ì•„ìš”, ê²½ë¹„ ë³´ê¸°, ê²Œì‹œê¸€ ì‚­ì œ*/}
          <div style={{ marginLeft: "50px" }}>
            <Button onClick={heartClick}>
              {heart ? "â™¥ï¸" : "â™¡"} {heartCnt}
            </Button>
            {snsData?.expNo ? (
              <>
                <Button value={snsData.expNo} onClick={showExpInfo}>
                  ê²½ë¹„ ì •ë³´
                </Button>
              </>
            ) : (
              <></>
            )}
            {snsData?.snsUser?.userNo == userNo ? (
              <Button value={snsData?.snsNo} onClick={snsDeleteClick} danger>
                ê²Œì‹œê¸€ ì‚­ì œ
              </Button>
            ) : (
              <></>
            )}
          </div>
        </div>
        {/* ëŒ“ê¸€ */}
        <div
          className="comment"
          style={{
            overflowY: "auto",
            overflowX: "hidden",
            height: "250px",
          }}
        >
          {replyData?.map((reply, i) => {
            return (
              <div
                className="reply"
                key={i}
                style={{
                  justifyContent: "flex-start",
                }}
              >
                <img
                  onClick={moveToProfile}
                  value={reply?.replyUser.userNick}
                  className="repProfile"
                  src={reply?.replyUser.userProfile}
                  alt="ëŒ“ê¸€ í”„ë¡œí•„"
                />
                <h3
                  onClick={moveToProfile}
                  value={reply?.replyUser.userNick}
                  className="repName"
                >
                  {reply?.replyUser.userNick}
                </h3>
                <div style={{ width: "40%" }}>
                  <h3>{reply?.replyContent}</h3>
                  <p>
                    {reply
                      ? new Date(reply?.replyRegdate)
                          .toISOString()
                          .split("T")[0] +
                        " " +
                        new Date(reply?.replyRegdate)
                          .toISOString()
                          .split("T")[1]
                          .split(".")[0]
                      : ""}
                  </p>
                </div>
                <div style={{ textAlign: "right" }}>
                  {userNo == reply?.replyUser.userNo ? (
                    <Button
                      danger
                      value={reply?.replyNo}
                      onClick={replyDeleteClick}
                    >
                      X
                    </Button>
                  ) : (
                    <Button style={{ visibility: "hidden" }}>X</Button>
                  )}
                </div>
              </div>
            );
          })}
        </div>
        {/* ëŒ“ê¸€ ì‘ì„± */}
        <div style={{ height: "20%" }}>
          <Space direction="vertical" size="middle">
            <Space.Compact
              className="repInput"
              style={{
                width: "100%",
              }}
            >
              <TextArea
                className="replyArea"
                placeholder="ëŒ“ê¸€ ì‘ì„±..."
                rows={4}
                name="rep"
                onChange={replyRegisterChange}
                value={replyContent}
              />
              <Button
                type="primary"
                onClick={replyRegisterClick}
                style={{ height: "99px" }}
              >
                ê²Œì‹œ
              </Button>
            </Space.Compact>
          </Space>
        </div>
      </div>
      {/* ê²½ë¹„ ëª¨ë‹¬ */}
      <Modal
        data={exp}
        title="ê²½ë¹„ ì •ë³´"
        open={isModalOpen}
        onOk={handleOk}
        onCancel={handleCancel}
      >
        <p>ì œëª©: {exp.expTitle}</p>
        <p>ì‚¬ìš©ì²˜: {exp.expPlace}</p>
        <p>ê²°ì œ ê¸ˆì•¡: {exp.expMoney}ì›</p>
      </Modal>
    </div>
  );
};

export default SnsDetail;
